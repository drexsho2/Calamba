<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PH Angkas Padala - Book & Track</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body, #app { height: 100%; font-family: 'Inter', sans-serif; }
    body { display: flex; flex-direction: column; min-height: 100vh; }
    
    header { 
      background: linear-gradient(135deg, #dc2626, #fbbf24); 
      color: white; padding: 16px 24px; 
      display: flex; align-items: center; 
      justify-content: space-between; 
      font-weight: 700; font-size: 1.5rem; 
      position: sticky; top: 0; z-index: 1000; 
      box-shadow: 0 4px 12px rgb(220 38 38 / 0.4); 
    }
    
    .logo { display: flex; align-items: center; gap: 8px; }
    .logo i.material-icons { font-size: 2rem; }
    
    #app { flex-grow: 1; display: flex; flex-direction: column; }
    main { flex-grow: 1; display: flex; flex-direction: column; }
    
    #map { 
      flex-grow: 1; 
      min-height: 400px; 
      z-index: 1;
    }
    
    /* Booking Panel */
    #booking-panel {
      position: absolute;
      top: 80px;
      right: 20px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      width: 300px;
      max-width: 90%;
    }
    
    #booking-panel h2 {
      color: #dc2626;
      margin-bottom: 12px;
      font-size: 1.2rem;
    }
    
    .form-group {
      margin-bottom: 12px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
      color: #334155;
    }
    
    .form-group input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-family: 'Inter', sans-serif;
    }
    
    #book-btn {
      width: 100%;
      padding: 10px;
      background: #fbbf24;
      color: #dc2626;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 8px;
    }
    
    #book-btn:hover {
      background: #dc2626;
      color: white;
    }
    
    /* Controls */
    #controls {
      position: absolute;
      bottom: 20px;
      left: 20px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    #trackBtn {
      background: #fbbf24;
      color: #dc2626;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    #trackBtn:hover {
      background: #dc2626;
      color: white;
    }
    
    .pulse-icon {
      background: #dc2626;
      border-radius: 50%;
      width: 15px;
      height: 15px;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(3); opacity: 0; }
    }
    
    .leaflet-popup-content {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <i class="material-icons" aria-hidden="true">motorcycle</i>
      <span>PH Angkas Padala</span>
    </div>
  </header>
  
  <div id="app">
    <main>
      <div id="map"></div>
      
      <!-- Booking Panel -->
      <div id="booking-panel">
        <h2>Book a Ride</h2>
        <form id="booking-form">
          <div class="form-group">
            <label for="pickup">Pickup Location</label>
            <input type="text" id="pickup" placeholder="Enter pickup address">
          </div>
          <div class="form-group">
            <label for="destination">Destination</label>
            <input type="text" id="destination" placeholder="Enter destination">
          </div>
          <button type="submit" id="book-btn">
            <i class="material-icons">directions_bike</i>
            Book Now
          </button>
        </form>
      </div>
      
      <!-- GPS Controls -->
      <div id="controls">
        <button id="trackBtn">
          <i class="material-icons">my_location</i>
          <span>Start Tracking</span>
        </button>
      </div>
    </main>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize map with Manila coordinates
      const map = L.map('map').setView([14.5995, 120.9842], 13);
      
      // Add OpenStreetMap tiles (free, no API key needed)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      
      // Create tracking elements
      let userMarker = null;
      let watchId = null;
      const pathPoints = [];
      let pathPolyline = L.polyline([], {color: '#dc2626'}).addTo(map);
      
      // DOM elements
      const trackBtn = document.getElementById('trackBtn');
      const trackText = trackBtn.querySelector('span');
      const trackIcon = trackBtn.querySelector('i');
      const bookingForm = document.getElementById('booking-form');
      
      // Tracking function
      function startTracking() {
        if (navigator.geolocation) {
          trackText.textContent = 'Tracking...';
          trackIcon.textContent = 'gps_fixed';
          trackBtn.style.background = '#dc2626';
          trackBtn.style.color = 'white';
          
          watchId = navigator.geolocation.watchPosition(
            position => {
              const { latitude, longitude } = position.coords;
              const accuracy = position.coords.accuracy;
              
              // Update or create marker
              if (!userMarker) {
                userMarker = L.marker([latitude, longitude], {
                  icon: L.divIcon({ className: 'pulse-icon' })
                }).addTo(map);
                
                userMarker.bindPopup(`
                  <b>Your Location</b><br>
                  Accuracy: ${Math.round(accuracy)} meters
                `).openPopup();
                
                // Auto-fill pickup location if empty
                if (!document.getElementById('pickup').value) {
                  reverseGeocode(latitude, longitude, (address) => {
                    document.getElementById('pickup').value = address;
                  });
                }
              } else {
                userMarker.setLatLng([latitude, longitude]);
                userMarker.setPopupContent(`
                  <b>Your Location</b><br>
                  Accuracy: ${Math.round(accuracy)} meters
                `);
              }
              
              // Update path
              pathPoints.push([latitude, longitude]);
              pathPolyline.setLatLngs(pathPoints);
              
              // Center map
              map.setView([latitude, longitude], 16);
            },
            error => {
              console.error("GPS Error:", error);
              alert(`GPS Error: ${error.message}`);
              stopTracking();
            },
            {
              enableHighAccuracy: true,
              maximumAge: 0,
              timeout: 5000
            }
          );
        } else {
          alert("Geolocation is not supported by your browser.");
        }
      }
      
      function stopTracking() {
        if (watchId) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
        }
        trackText.textContent = 'Start Tracking';
        trackIcon.textContent = 'my_location';
        trackBtn.style.background = '#fbbf24';
        trackBtn.style.color = '#dc2626';
      }
      
      // Reverse geocode function
      function reverseGeocode(lat, lng, callback) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
          .then(response => response.json())
          .then(data => {
            const address = data.display_name || "Current Location";
            callback(address);
          })
          .catch(() => callback("Current Location"));
      }
      
      // Handle booking form submission
      bookingForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const pickup = document.getElementById('pickup').value;
        const destination = document.getElementById('destination').value;
        
        if (!pickup || !destination) {
          alert('Please enter both pickup and destination locations');
          return;
        }
        
        // In a real app, you would send this to your backend
        alert(`Booking requested!\nFrom: ${pickup}\nTo: ${destination}`);
        
        // Reset form
        bookingForm.reset();
      });
      
      // Toggle tracking
      trackBtn.addEventListener('click', function() {
        if (watchId) {
          stopTracking();
        } else {
          startTracking();
        }
      });
      
      // Add attribution
      L.control.attribution({
        position: 'bottomright',
        prefix: '<a href="https://leafletjs.com/">Leaflet</a> | PH Angkas Padala'
      }).addTo(map);
    });
  </script>
</body>
</html>
